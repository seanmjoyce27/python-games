<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ game.display_name }} - Code Editor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
</head>

<body>
    <div class="game-container">
        <header class="game-header">
            <a href="/" class="back-btn">‚Üê Back</a>
            <h1>{{ game.display_name }}</h1>
            <div class="header-actions">
                <button id="missionsBtn" class="btn-missions">üéØ Missions</button>
                <span id="saveStatus"></span>
                <button id="historyBtn" class="btn-secondary">üìú History</button>
                <button id="saveBtn" class="btn-primary">üíæ Save Checkpoint</button>
            </div>
        </header>

        <div class="workspace">
            <div class="editor-panel">
                <div class="panel-header">
                    <h3>Your Code</h3>
                    <button id="runBtn" class="btn-run">‚ñ∂ Run Code</button>
                </div>
                <textarea id="codeEditor">{{ game.template_code }}</textarea>
                <div class="editor-footer">
                    <span id="lineCount"></span>
                </div>
            </div>

            <div class="game-panel">
                <div class="panel-header">
                    <h3>Game Preview</h3>
                    <button id="stopBtn" class="btn-stop" style="display: none;">‚èπ Stop</button>
                </div>
                <div id="gameCanvas">
                    <canvas id="canvas" width="600" height="600"></canvas>
                    <div id="gameOutput"></div>
                </div>
                <div id="gameError" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content history-modal">
            <div class="modal-header">
                <h2>Version History</h2>
                <button id="closeHistoryBtn" class="close-btn">√ó</button>
            </div>
            <div class="history-list" id="historyList">
                <p class="loading">Loading history...</p>
            </div>
        </div>
    </div>

    <!-- Diff Modal -->
    <div id="diffModal" class="modal" style="display: none;">
        <div class="modal-content diff-modal">
            <div class="modal-header">
                <h2>Code Changes</h2>
                <button id="closeDiffBtn" class="close-btn">√ó</button>
            </div>
            <pre id="diffContent"></pre>
        </div>
    </div>

    <!-- Missions Overlay Panel -->
    <div id="missionsOverlay" class="missions-overlay">
        <div class="missions-sidebar">
            <div class="missions-sidebar-header">
                <h2>üéØ Missions</h2>
                <button id="closeMissionsOverlay" class="close-btn">√ó</button>
            </div>
            <div id="missionsListOverlay" class="missions-list-overlay">
                <p class="loading">Loading missions...</p>
            </div>
        </div>
    </div>

    <!-- Mission Detail Modal -->
    <div id="missionModal" class="modal" style="display: none;">
        <div class="modal-content mission-modal">
            <div class="modal-header">
                <h2 id="missionTitle"></h2>
                <button id="closeMissionBtn" class="close-btn">√ó</button>
            </div>
            <div class="mission-content">
                <p id="missionDescription" class="mission-description"></p>
                <div id="missionHints" class="mission-hints" style="display: none;">
                    <h4>üí° Hints:</h4>
                    <ul id="hintsList"></ul>
                </div>
                <div id="missionFeedback" class="mission-feedback" style="display: none;"></div>
                <div class="mission-actions">
                    <button id="startMissionBtn" class="btn-primary">Start Mission</button>
                    <button id="showHintsBtn" class="btn-secondary" style="display: none;">Show Hints</button>
                    <button id="validateMissionBtn" class="btn-success" style="display: none;">‚úì Check My Code</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        const gameId = {{ game.id }};
        const userId = new URLSearchParams(window.location.search).get('user_id');
        let pyodide = null;
        let autoSaveInterval = null;
        let editor = null;

        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true
        });

        editor.on('change', () => {
            const lines = editor.lineCount();
            document.getElementById('lineCount').textContent = `${lines} lines`;
        });

        // Initialize Pyodide
        async function initPyodide() {
            document.getElementById('gameOutput').innerHTML = '<p class="loading">‚è≥ Loading Python environment (this may take a minute)...</p>';
            try {
                pyodide = await loadPyodide();
                document.getElementById('gameOutput').innerHTML = `
                    <p class="success">‚úì Python is ready!</p>
                    <p class="info">Click "‚ñ∂ Run Code" to execute your Python code.</p>
                    <p class="info">Add print() statements to see output here!</p>
                `;
            } catch (error) {
                document.getElementById('gameOutput').innerHTML = '<p class="error">‚ùå Error loading Python: ' + error.message + '</p>';
            }
        }

        // Load saved code
        async function loadCode() {
            try {
                const response = await fetch('/api/code/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, game_id: gameId })
                });
                const data = await response.json();
                if (data.code) {
                    editor.setValue(data.code);
                }
            } catch (error) {
                console.error('Error loading code:', error);
            }
        }

        // Auto-save code
        async function autoSave() {
            const code = editor.getValue();
            try {
                const response = await fetch('/api/code/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        game_id: gameId,
                        code: code,
                        is_checkpoint: false
                    })
                });
                const data = await response.json();
                if (response.ok && data.message !== 'No changes detected') {
                    showSaveStatus('Auto-saved ‚úì');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        }

        // Manual checkpoint save
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const message = prompt('Add a note about this version (optional):');
            if (message === null) return; // User cancelled

            const code = editor.getValue();
            try {
                const response = await fetch('/api/code/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        game_id: gameId,
                        code: code,
                        message: message,
                        is_checkpoint: true
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showSaveStatus('Checkpoint saved! ‚úì', 3000);
                }
            } catch (error) {
                showSaveStatus('Save failed ‚úó', 3000);
            }
        });

        function showSaveStatus(message, duration = 2000) {
            const status = document.getElementById('saveStatus');
            status.textContent = message;
            status.style.opacity = '1';
            setTimeout(() => {
                status.style.opacity = '0';
            }, duration);
        }

        // Run Python code
        document.getElementById('runBtn').addEventListener('click', async () => {
            if (!pyodide) {
                alert('Python is still loading. Please wait...');
                return;
            }

            const code = editor.getValue();
            const output = document.getElementById('gameOutput');
            const errorDiv = document.getElementById('gameError');

            output.innerHTML = '<p class="loading">Running your code...</p>';
            errorDiv.textContent = '';

            try {
                // Setup Canvas Context for global access
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');

                // Keyboard state tracking
                window.keysPressed = {};
                window.lastKeyPressed = '';

                // Setup keyboard listeners
                window.addEventListener('keydown', (e) => {
                    window.keysPressed[e.key] = true;
                    window.lastKeyPressed = e.key;
                    // Prevent arrow keys from scrolling
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                        e.preventDefault();
                    }
                });

                window.addEventListener('keyup', (e) => {
                    window.keysPressed[e.key] = false;
                });

                // Expose drawing functions to window for Python to access via 'js' module
                window.clear_screen = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                };

                window.draw_rect = function (x, y, width, height, color) {
                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, width, height);
                };

                window.draw_circle = function (x, y, radius, color) {
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                    ctx.fillStyle = color;
                    ctx.fill();
                };

                window.draw_text = function (text, x, y, color, font) {
                    ctx.fillStyle = color;
                    ctx.font = font || '20px Arial';
                    ctx.fillText(text, x, y);
                };

                // Keyboard helper functions
                window.is_key_pressed = function(key) {
                    return window.keysPressed[key] === true;
                };

                window.get_last_key = function() {
                    return window.lastKeyPressed;
                };

                // Game Loop State
                let gameInterval = null;
                let requestID = null;

                function stopGame() {
                    if (requestID) {
                        cancelAnimationFrame(requestID);
                        requestID = null;
                    }
                    window.clear_screen();
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('runBtn').style.display = 'inline-block';
                }

                document.getElementById('stopBtn').addEventListener('click', stopGame);

                // Capture print statements
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
`);

                // Run user code
                pyodide.runPython(code);

                // Start Game Loop if 'update' or 'draw' are defined in Python
                const hasUpdate = pyodide.runPython(" 'update' in globals() ");
                const hasDraw = pyodide.runPython(" 'draw' in globals() ");

                if (hasUpdate || hasDraw) {
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    document.getElementById('runBtn').style.display = 'none';

                    function gameLoop() {
                        try {
                            if (hasUpdate) pyodide.runPython("update()");
                            if (hasDraw) pyodide.runPython("draw()");
                            requestID = requestAnimationFrame(gameLoop);
                        } catch (error) {
                            console.error("Game Loop Error:", error);
                            stopGame();
                            errorDiv.textContent = "Runtime Error: " + error.message;
                        }
                    }

                    gameLoop();
                }

                // Get output
                const stdout = pyodide.runPython('sys.stdout.getvalue()');

                if (stdout) {
                    output.innerHTML = '<pre>' + stdout + '</pre>';
                } else if (!hasUpdate && !hasDraw) {
                    // Only show success message if NOT running a game loop
                    // (otherwise it flashes quickly before loop starts drawing)
                    output.innerHTML = `
                        <p class="success">‚úì Code ran successfully!</p>
                        <p class="info">üí° Tip: Define update() and draw() functions to create a game!</p>
                    `;
                }


            } catch (error) {
                errorDiv.textContent = error.message;
                output.innerHTML = '<p class="error">Code has errors (see below)</p>';
            }
        });

        // History button with pagination for unlimited saves
        let currentOffset = 0;
        const historyLimit = 50;

        document.getElementById('historyBtn').addEventListener('click', async () => {
            currentOffset = 0;
            await loadHistory(currentOffset);
        });

        async function loadHistory(offset = 0) {
            document.getElementById('historyModal').style.display = 'flex';
            const historyList = document.getElementById('historyList');

            if (offset === 0) {
                historyList.innerHTML = '<p class="loading">Loading history...</p>';
            } else {
                historyList.innerHTML += '<p class="loading">Loading more...</p>';
            }

            try {
                const response = await fetch('/api/code/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        game_id: gameId,
                        limit: historyLimit,
                        offset: offset
                    })
                });
                const data = await response.json();

                if (data.total === 0) {
                    historyList.innerHTML = '<p>No saved versions yet. Your first auto-save will appear here!</p>';
                    return;
                }

                const versions = data.versions;
                const versionHtml = versions.map((v, index) => {
                    const globalIndex = offset + index;
                    return `
                    <div class="history-item ${v.is_checkpoint ? 'checkpoint' : ''}">
                        <div class="history-header">
                            <span class="history-title">
                                ${v.is_checkpoint ? 'üìå Checkpoint' : 'üíæ Auto-save'} ${globalIndex === 0 ? '(Current)' : ''}
                            </span>
                            <span class="history-date">${new Date(v.created_at).toLocaleString()}</span>
                        </div>
                        ${v.message ? `<div class="history-message">${v.message}</div>` : ''}
                        <div class="history-actions">
                            <button class="btn-small view-btn" data-version-id="${v.id}">View Code</button>
                            ${globalIndex > 0 ? `<button class="btn-small diff-btn" data-version-id="${v.id}" data-prev-id="${versions[0].id}">See Changes</button>` : ''}
                            ${globalIndex > 0 ? `<button class="btn-small restore-btn" data-version-id="${v.id}">Restore This</button>` : ''}
                        </div>
                    </div>
                `}).join('');

                if (offset === 0) {
                    historyList.innerHTML = `
                        <div class="history-info">
                            <p>Total saves: ${data.total}</p>
                        </div>
                        ${versionHtml}
                    `;
                } else {
                    const loadingMsg = historyList.querySelector('.loading');
                    if (loadingMsg) loadingMsg.remove();
                    historyList.innerHTML += versionHtml;
                }

                // Add "Load More" button if there are more versions
                if (data.has_more) {
                    const loadMoreBtn = document.createElement('button');
                    loadMoreBtn.className = 'btn-load-more';
                    loadMoreBtn.textContent = `Load More (${data.total - offset - historyLimit} remaining)`;
                    loadMoreBtn.onclick = () => {
                        loadMoreBtn.remove();
                        currentOffset += historyLimit;
                        loadHistory(currentOffset);
                    };
                    historyList.appendChild(loadMoreBtn);
                }

                // Attach event listeners to new items
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewVersion(btn.dataset.versionId));
                });

                document.querySelectorAll('.diff-btn').forEach(btn => {
                    btn.addEventListener('click', () => showDiff(btn.dataset.versionId, btn.dataset.prevId));
                });

                document.querySelectorAll('.restore-btn').forEach(btn => {
                    btn.addEventListener('click', () => restoreVersion(btn.dataset.versionId));
                });

            } catch (error) {
                historyList.innerHTML = '<p class="error">Error loading history</p>';
            }
        }

        async function viewVersion(versionId) {
            try {
                const response = await fetch(`/api/code/version/${versionId}`);
                const data = await response.json();
                editor.setValue(data.code);
                document.getElementById('historyModal').style.display = 'none';
                alert('Viewing this version. Click "Save Checkpoint" if you want to keep these changes.');
            } catch (error) {
                alert('Error loading version');
            }
        }

        async function showDiff(version1Id, version2Id) {
            try {
                const response = await fetch('/api/code/diff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version1_id: version2Id, version2_id: version1Id })
                });
                const data = await response.json();

                document.getElementById('diffContent').textContent = data.diff.join('\n');
                document.getElementById('diffModal').style.display = 'flex';
            } catch (error) {
                alert('Error loading diff');
            }
        }

        async function restoreVersion(versionId) {
            if (!confirm('Restore this version? This will create a new checkpoint with the old code.')) {
                return;
            }

            try {
                const response = await fetch(`/api/code/restore/${versionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();

                if (response.ok) {
                    editor.setValue(data.code);
                    document.getElementById('historyModal').style.display = 'none';
                    showSaveStatus('Version restored! ‚úì', 3000);
                }
            } catch (error) {
                alert('Error restoring version');
            }
        }

        // Modal close buttons
        document.getElementById('closeHistoryBtn').addEventListener('click', () => {
            document.getElementById('historyModal').style.display = 'none';
        });

        document.getElementById('closeDiffBtn').addEventListener('click', () => {
            document.getElementById('diffModal').style.display = 'none';
        });

        // Initialize
        if (!userId) {
            alert('Please select a user first!');
            window.location.href = '/';
        } else {
            loadCode();
            initPyodide();

            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(autoSave, 30000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
        });

        // ===== MISSIONS SYSTEM =====
        let missions = [];
        let currentMission = null;
        let missionProgress = {};

        // Load missions for this game
        async function loadMissions() {
            try {
                const response = await fetch(`/api/missions/${gameId}`);
                missions = await response.json();
                renderMissionsList();

                // Load progress for each mission
                if (userId) {
                    for (const mission of missions) {
                        await loadMissionProgress(mission.id);
                    }
                    renderMissionsList();
                }
            } catch (error) {
                console.error('Error loading missions:', error);
                document.getElementById('missionsList').innerHTML = '<p class="error">Failed to load missions</p>';
            }
        }

        async function loadMissionProgress(missionId) {
            if (!userId) return;

            try {
                const response = await fetch(`/api/missions/${missionId}/progress?user_id=${userId}`);
                const progress = await response.json();
                missionProgress[missionId] = progress;
            } catch (error) {
                console.error('Error loading mission progress:', error);
            }
        }

        function renderMissionsList() {
            const container = document.getElementById('missionsListOverlay');

            if (missions.length === 0) {
                container.innerHTML = '<p class="info">No missions available yet for this game.</p>';
                return;
            }

            container.innerHTML = missions.map(mission => {
                const progress = missionProgress[mission.id] || { status: 'not_started', attempts: 0 };
                const statusEmoji = {
                    'not_started': '‚≠ï',
                    'in_progress': 'üîÑ',
                    'completed': '‚úÖ',
                    'failed': '‚ùå'
                };
                const statusClass = progress.status.replace('_', '-');

                return `
                    <div class="mission-item ${statusClass}" data-mission-id="${mission.id}">
                        <div class="mission-header">
                            <span class="mission-status">${statusEmoji[progress.status]}</span>
                            <span class="mission-number">#${mission.order}</span>
                            <h4 class="mission-title-short">${mission.title}</h4>
                        </div>
                        <div class="mission-meta">
                            <span class="difficulty ${mission.difficulty}">${mission.difficulty}</span>
                            ${progress.attempts > 0 ? `<span class="attempts">${progress.attempts} attempts</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.mission-item').forEach(item => {
                item.addEventListener('click', () => {
                    const missionId = parseInt(item.dataset.missionId);
                    showMissionDetail(missionId);
                });
            });
        }

        function showMissionDetail(missionId) {
            currentMission = missions.find(m => m.id === missionId);
            if (!currentMission) return;

            const progress = missionProgress[missionId] || { status: 'not_started', attempts: 0 };

            // Set modal content
            document.getElementById('missionTitle').textContent = `Mission ${currentMission.order}: ${currentMission.title}`;
            document.getElementById('missionDescription').textContent = currentMission.description;

            // Parse and display hints
            const hints = JSON.parse(currentMission.hints || '[]');
            if (hints.length > 0) {
                document.getElementById('hintsList').innerHTML = hints.map(hint => `<li>${hint}</li>`).join('');
            }

            // Update button states based on progress
            const startBtn = document.getElementById('startMissionBtn');
            const hintsBtn = document.getElementById('showHintsBtn');
            const validateBtn = document.getElementById('validateMissionBtn');
            const feedbackDiv = document.getElementById('missionFeedback');

            if (progress.status === 'completed') {
                startBtn.style.display = 'none';
                hintsBtn.style.display = 'none';
                validateBtn.style.display = 'none';
                feedbackDiv.style.display = 'block';
                feedbackDiv.className = 'mission-feedback success';
                feedbackDiv.textContent = '‚úÖ Mission Complete! Great job!';
            } else if (progress.status === 'in_progress') {
                startBtn.style.display = 'none';
                hintsBtn.style.display = 'inline-block';
                validateBtn.style.display = 'inline-block';

                // Show previous feedback if exists
                if (progress.validation_result) {
                    const result = JSON.parse(progress.validation_result);
                    if (result.feedback) {
                        feedbackDiv.style.display = 'block';
                        feedbackDiv.className = result.success ? 'mission-feedback success' : 'mission-feedback error';
                        feedbackDiv.textContent = result.feedback;
                    }
                }
            } else {
                startBtn.style.display = 'inline-block';
                hintsBtn.style.display = 'none';
                validateBtn.style.display = 'none';
                feedbackDiv.style.display = 'none';
            }

            // Reset hints visibility
            document.getElementById('missionHints').style.display = 'none';

            // Show modal
            document.getElementById('missionModal').style.display = 'flex';
        }

        // Start mission
        document.getElementById('startMissionBtn').addEventListener('click', async () => {
            if (!userId) {
                alert('Please select a user first!');
                return;
            }

            if (!currentMission) return;

            try {
                const response = await fetch(`/api/missions/${currentMission.id}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        action: 'start'
                    })
                });

                if (response.ok) {
                    await loadMissionProgress(currentMission.id);
                    showMissionDetail(currentMission.id);
                    renderMissionsList();
                }
            } catch (error) {
                console.error('Error starting mission:', error);
                alert('Failed to start mission');
            }
        });

        // Show hints
        document.getElementById('showHintsBtn').addEventListener('click', () => {
            const hintsDiv = document.getElementById('missionHints');
            hintsDiv.style.display = hintsDiv.style.display === 'none' ? 'block' : 'none';
        });

        // Validate mission
        document.getElementById('validateMissionBtn').addEventListener('click', async () => {
            if (!userId || !currentMission) return;

            const code = editor.getValue();
            const feedbackDiv = document.getElementById('missionFeedback');

            // Show loading state
            feedbackDiv.style.display = 'block';
            feedbackDiv.className = 'mission-feedback';
            feedbackDiv.textContent = 'üîÑ Checking your code...';

            try {
                const response = await fetch(`/api/missions/${currentMission.id}/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        code: code
                    })
                });

                const result = await response.json();

                // Update feedback
                feedbackDiv.className = result.success ? 'mission-feedback success' : 'mission-feedback error';
                feedbackDiv.textContent = result.feedback;

                // Reload progress and update UI
                await loadMissionProgress(currentMission.id);
                renderMissionsList();

                // If completed, update button states
                if (result.success) {
                    setTimeout(() => {
                        document.getElementById('startMissionBtn').style.display = 'none';
                        document.getElementById('validateMissionBtn').style.display = 'none';
                        document.getElementById('showHintsBtn').style.display = 'none';
                    }, 1000);
                }

            } catch (error) {
                console.error('Error validating mission:', error);
                feedbackDiv.className = 'mission-feedback error';
                feedbackDiv.textContent = 'Error checking code. Please try again.';
            }
        });

        // Open missions overlay
        document.getElementById('missionsBtn').addEventListener('click', () => {
            document.getElementById('missionsOverlay').classList.add('active');
        });

        // Close missions overlay
        document.getElementById('closeMissionsOverlay').addEventListener('click', () => {
            document.getElementById('missionsOverlay').classList.remove('active');
        });

        // Close overlay when clicking outside sidebar
        document.getElementById('missionsOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'missionsOverlay') {
                document.getElementById('missionsOverlay').classList.remove('active');
            }
        });

        // Close mission modal
        document.getElementById('closeMissionBtn').addEventListener('click', () => {
            document.getElementById('missionModal').style.display = 'none';
        });

        // Load missions when user is selected
        if (userId) {
            loadMissions();
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Game Builder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üéÆ Python Game Builder</h1>
                <p>Learn Python by creating awesome games!</p>
            </div>
            <a href="/admin" style="position: absolute; top: 2rem; right: 2rem; color: #888; text-decoration: none; font-size: 0.875rem;">Admin</a>
        </header>

        <section class="leaderboard-section">
            <h2>üèÜ Mission Leaderboard</h2>
            <div id="leaderboard" class="leaderboard">
                <!-- Leaderboard will be loaded here -->
            </div>
        </section>

        <section class="user-section">
            <h2>Choose Your Coder</h2>
            <div class="user-selector">
                <div id="activeUsers" class="user-list">
                    <!-- Active users will be loaded here -->
                </div>
                <button id="newUserBtn" class="btn-primary">+ Choose New Avatar</button>
            </div>
        </section>

        <section class="games-section" id="gamesSection" style="display: none;">
            <h2>Choose Your Game</h2>
            <div class="games-grid">
                {% for game in games %}
                <div class="game-card">
                    <h3>{{ game.display_name }}</h3>
                    <p>{{ game.description }}</p>
                    <button class="btn-play" data-game-id="{{ game.id }}">
                        Start Coding
                    </button>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>

    <!-- Avatar Selection Modal -->
    <div id="avatarModal" class="modal" style="display: none;">
        <div class="modal-content avatar-modal">
            <div class="modal-header">
                <h2>üöÄ Choose Your Coding Avatar</h2>
                <button id="closeAvatarModal" class="close-btn">√ó</button>
            </div>
            <div class="avatar-grid" id="avatarGrid">
                <p class="loading">Loading avatars...</p>
            </div>
        </div>
    </div>

    <script>
        let selectedUserId = null;

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const leaderboard = await response.json();

                const container = document.getElementById('leaderboard');

                if (leaderboard.length === 0) {
                    container.innerHTML = '<p class="info">No coders yet! Complete missions to climb the leaderboard.</p>';
                    return;
                }

                container.innerHTML = leaderboard.map((entry, index) => {
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;

                    return `
                        <div class="leaderboard-entry ${rank <= 3 ? 'top-three' : ''}">
                            <div class="leaderboard-rank">${medal}</div>
                            <div class="leaderboard-avatar">
                                <div class="avatar-emoji-small" style="background: ${entry.avatar.color}">
                                    ${entry.avatar.emoji}
                                </div>
                            </div>
                            <div class="leaderboard-name">${entry.avatar.name}</div>
                            <div class="leaderboard-score">
                                <span class="score-number">${entry.completed_missions}</span>
                                <span class="score-label">mission${entry.completed_missions !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Load active users on page load
        async function loadActiveUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();

                const container = document.getElementById('activeUsers');

                if (users.length === 0) {
                    container.innerHTML = '<p class="info">No coders yet! Choose an avatar to get started.</p>';
                    return;
                }

                container.innerHTML = users.map(user => `
                    <div class="avatar-card active" data-user-id="${user.id}">
                        <div class="avatar-emoji" style="background: ${user.avatar.color}">
                            ${user.avatar.emoji}
                        </div>
                        <div class="avatar-name">${user.avatar.name}</div>
                    </div>
                `).join('');

                // Add click handlers
                document.querySelectorAll('.avatar-card.active').forEach(card => {
                    card.addEventListener('click', function() {
                        selectedUserId = this.dataset.userId;
                        document.querySelectorAll('.avatar-card.active').forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                        document.getElementById('gamesSection').style.display = 'block';
                    });
                });

            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load avatars for selection
        async function loadAvatars() {
            try {
                const response = await fetch('/api/avatars');
                const avatars = await response.json();

                const grid = document.getElementById('avatarGrid');

                grid.innerHTML = avatars.map(avatar => `
                    <div class="avatar-card ${avatar.available ? 'available' : 'taken'}"
                         data-avatar-id="${avatar.id}"
                         ${!avatar.available ? 'title="Already chosen by another coder"' : ''}>
                        <div class="avatar-emoji" style="background: ${avatar.color}">
                            ${avatar.emoji}
                        </div>
                        <div class="avatar-name">${avatar.name}</div>
                        ${!avatar.available ? '<div class="taken-badge">Taken</div>' : ''}
                    </div>
                `).join('');

                // Add click handlers only to available avatars
                document.querySelectorAll('.avatar-card.available').forEach(card => {
                    card.addEventListener('click', async function() {
                        const avatarId = parseInt(this.dataset.avatarId);
                        await createUser(avatarId);
                    });
                });

            } catch (error) {
                console.error('Error loading avatars:', error);
                document.getElementById('avatarGrid').innerHTML = '<p class="error">Failed to load avatars</p>';
            }
        }

        // Create user with selected avatar
        async function createUser(avatarId) {
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avatar_id: avatarId })
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('avatarModal').style.display = 'none';
                    await loadActiveUsers();

                    // Auto-select the new user
                    setTimeout(() => {
                        const userCard = document.querySelector(`[data-user-id="${user.id}"]`);
                        if (userCard) {
                            userCard.click();
                        }
                    }, 100);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Failed to create user');
            }
        }

        // Show avatar modal
        document.getElementById('newUserBtn').addEventListener('click', () => {
            document.getElementById('avatarModal').style.display = 'flex';
            loadAvatars();
        });

        // Close modal
        document.getElementById('closeAvatarModal').addEventListener('click', () => {
            document.getElementById('avatarModal').style.display = 'none';
        });

        // Game selection
        document.querySelectorAll('.btn-play').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!selectedUserId) {
                    alert('Please select a coder first!');
                    return;
                }
                const gameId = this.dataset.gameId;
                window.location.href = `/game/${gameId}?user_id=${selectedUserId}`;
            });
        });

        // Load leaderboard and active users on page load
        loadLeaderboard();
        loadActiveUsers();
    </script>
</body>
</html>
